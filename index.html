<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Jeu - Mange Formes</title>
  <style>
    body { margin: 0; overflow: hidden; background: #f0f0f0; }
    canvas { display: block; }
    #score, #timer, #pseudoDisplay, #highscoreDisplay {
      position: absolute;
      font-family: sans-serif;
      font-size: 20px;
      background: rgba(255, 255, 255, 0.7);
      padding: 5px 10px;
      border-radius: 10px;
      z-index: 2;
    }
    #score { top: 10px; left: 10px; }
    #timer { top: 10px; right: 10px; }
    #pseudoDisplay { top: 50px; left: 10px; }
    #highscoreDisplay { top: 90px; left: 10px; }
    #leaderboardDisplay {
      position: absolute;
      top: 170px;
      left: 10px;
      background: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 16px;
      z-index: 2;
    }
    #startMenu, #gameover {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-family: sans-serif;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      z-index: 3;
    }
    #gameover { display: none; font-size: 40px; }
    #replayButton, #startButton {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: #ffffff;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="startMenu">
  <p>Bienvenue !</p>
  <label>Pseudo : <input type="text" id="pseudoInput" placeholder="Joueur" /></label><br><br>
  <label>Difficult√© :
    <select id="difficultySelect">
      <option value="easy">Facile</option>
      <option value="normal" selected>Normal</option>
      <option value="hard">Difficile</option>
    </select>
  </label><br><br>
  <label><input type="checkbox" id="soundToggle" checked> Activer la musique</label><br><br>
  <button id="startButton">Commencer le jeu</button>
</div>
<div id="score">Score: 0</div>
<div id="timer">Temps: 30</div>
<div id="pseudoDisplay"></div>
<div id="highscoreDisplay"></div>
<div style="position:absolute;top:130px;left:10px;z-index:3">
  <label for="leaderboardSelect">Voir classement pour : </label>
  <select id="leaderboardSelect">
    <option value="easy">Facile</option>
    <option value="normal" selected>Normal</option>
    <option value="hard">Difficile</option>
  </select>
  <button id="downloadBtn">üì• T√©l√©charger</button>
</div>
<div id="leaderboardDisplay"></div>
<div id="gameover">
  Game Over !<br>
  <button id="replayButton">Rejouer</button>
</div>
<audio id="bgmusic" src="https://cdn.pixabay.com/download/audio/2023/03/28/audio_0e7f15e112.mp3?filename=relaxing-music-117119.mp3" loop></audio>
<canvas id="game"></canvas>
<script>
let canvas = document.getElementById("game"),
    ctx = canvas.getContext("2d"),
    scoreEl = document.getElementById("score"),
    timerEl = document.getElementById("timer"),
    pseudoDisplay = document.getElementById("pseudoDisplay"),
    highscoreDisplay = document.getElementById("highscoreDisplay"),
    leaderboardDisplay = document.getElementById("leaderboardDisplay"),
    leaderboardSelect = document.getElementById("leaderboardSelect"),
    downloadBtn = document.getElementById("downloadBtn"),
    gameOverEl = document.getElementById("gameover"),
    replayButton = document.getElementById("replayButton"),
    bgMusic = document.getElementById("bgmusic"),
    startMenu = document.getElementById("startMenu"),
    startButton = document.getElementById("startButton"),
    soundToggle = document.getElementById("soundToggle"),
    pseudoInput = document.getElementById("pseudoInput"),
    difficultySelect = document.getElementById("difficultySelect");

let score, level, timeLeft, gameRunning, player, shapes, baseTime;
let pseudo = "", mouseX = 0, mouseY = 0;
const shapeTypes = ['circle', 'square', 'triangle'];

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

function getBaseTime() {
  const d = difficultySelect.value;
  return d === 'easy' ? 45 : d === 'hard' ? 20 : 30;
}

function showLeaderboard(difficulty, highlight = false) {
  const key = `leaderboard_${difficulty}`;
  let board = JSON.parse(localStorage.getItem(key)) || [];
  let html = `<strong>üèÜ Classement (${difficulty}) :</strong><br>`;
  board.slice(0, 3).forEach((e, i) => html += `#${i+1} ${e.pseudo} - ${e.score}<br>`);
  if (highlight) {
    const index = board.findIndex(e => e.pseudo === pseudo && e.score === score);
    if (index > 3) {
      const before = board[index - 1], after = board[index + 1];
      html += '<br><em>Autour de vous :</em><br>';
      if (before) html += `#${index} ${before.pseudo} - ${before.score}<br>`;
      html += `#${index + 1} <strong>${pseudo}</strong> - ${score}<br>`;
      if (after) html += `#${index + 2} ${after.pseudo} - ${after.score}<br>`;
    }
  }
  leaderboardDisplay.innerHTML = html;
}

function updateLeaderboard() {
  const diff = difficultySelect.value, key = `leaderboard_${diff}`;
  let board = JSON.parse(localStorage.getItem(key)) || [];
  board.push({ pseudo, score });
  board.sort((a, b) => b.score - a.score);
  localStorage.setItem(key, JSON.stringify(board.slice(0, 50)));
  showLeaderboard(diff, true);
}

function updateHighscore() {
  const best = JSON.parse(localStorage.getItem('bestScore')) || { score: 0, pseudo: '' };
  if (score > best.score) localStorage.setItem('bestScore', JSON.stringify({ score, pseudo }));
  const updated = JSON.parse(localStorage.getItem('bestScore'));
  highscoreDisplay.textContent = `Meilleur score: ${updated.score} (${updated.pseudo})`;
}

function initGame() {
  score = 0;
  level = 1;
  baseTime = getBaseTime();
  timeLeft = baseTime;
  gameRunning = true;
  scoreEl.textContent = `Score: ${score}`;
  timerEl.textContent = `Temps: ${timeLeft}`;
  pseudoDisplay.textContent = `Pseudo: ${pseudo}`;
  gameOverEl.style.display = 'none';
  leaderboardDisplay.innerHTML = "";
  updateHighscore();
  player = { x: canvas.width/2, y: canvas.height/2, size: 20, color: 'red' };
  shapes = [];
  spawnShapes(10);
  mouseX = player.x;
  mouseY = player.y;
  loop();
  startTimer();
}

function spawnShapes(n) {
  for (let i = 0; i < n; i++) {
    let s = 10 + Math.random() * 20;
    shapes.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: s,
      color: `hsl(${Math.random()*360},60%,50%)`,
      type: shapeTypes[Math.floor(Math.random()*shapeTypes.length)],
      alpha: 1
    });
  }
}

document.addEventListener("mousemove", e => {
  mouseX = e.clientX;
  mouseY = e.clientY;
});

function update() {
  if (!gameRunning) return;
  let dx = mouseX - player.x, dy = mouseY - player.y;
  player.x += dx * 0.1;
  player.y += dy * 0.1;
  for (let i = shapes.length - 1; i >= 0; i--) {
    let s = shapes[i];
    if (Math.hypot(player.x - s.x, player.y - s.y) < player.size + s.size) {
      shapes.splice(i, 1);
      score++;
      scoreEl.textContent = `Score: ${score}`;
      if (shapes.length === 0) {
        level++;
        timeLeft += Math.round(baseTime * 0.3);
        spawnShapes(5 + level * 2);
      }
    }
  }
}

function drawShape(s) {
  ctx.save();
  ctx.globalAlpha = s.alpha;
  ctx.fillStyle = s.color;
  ctx.beginPath();
  if (s.type === 'circle') ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
  else if (s.type === 'square') ctx.fillRect(s.x - s.size/2, s.y - s.size/2, s.size, s.size);
  else if (s.type === 'triangle') {
    ctx.moveTo(s.x, s.y - s.size);
    ctx.lineTo(s.x - s.size, s.y + s.size);
    ctx.lineTo(s.x + s.size, s.y + s.size);
    ctx.closePath();
  }
  ctx.fill();
  ctx.restore();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  shapes.forEach(drawShape);
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
  ctx.fillStyle = player.color;
  ctx.fill();
}

function loop() {
  update();
  draw();
  if (gameRunning) requestAnimationFrame(loop);
}

function startTimer() {
  const timer = setInterval(() => {
    if (!gameRunning) return clearInterval(timer);
    timeLeft--;
    timerEl.textContent = `Temps: ${timeLeft}`;
    if (timeLeft <= 0) {
      gameOver();
      clearInterval(timer);
    }
  }, 1000);
}

function gameOver() {
  gameRunning = false;
  gameOverEl.style.display = 'block';
  updateHighscore();
  updateLeaderboard();
}

startButton.addEventListener('click', () => {
  if (soundToggle.checked) bgMusic.play(); else bgMusic.pause();
  pseudo = pseudoInput.value.trim() || "Joueur";
  startMenu.style.display = 'none';
  initGame();
});

replayButton.addEventListener('click', () => {
  if (soundToggle.checked) bgMusic.play(); else bgMusic.pause();
  initGame();
});

leaderboardSelect.addEventListener('change', () => showLeaderboard(leaderboardSelect.value));

downloadBtn.addEventListener('click', () => {
  const difficulty = leaderboardSelect.value;
  const data = JSON.parse(localStorage.getItem(`leaderboard_${difficulty}`)) || [];
  let text = `Classement (${difficulty.toUpperCase()})\n\n`;
  data.forEach((entry, index) => {
    text += `#${index + 1} ${entry.pseudo} - ${entry.score}\n`;
  });
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `classement_${difficulty}.txt`;
  a.click();
  URL.revokeObjectURL(url);
});

window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>
</body>
</html>
